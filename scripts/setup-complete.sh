#!/bin/bash

# –ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/setup-complete.sh

set -e

echo "üöÄ –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ My-WebSite2.0"
echo "=================================================="
echo ""

# –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
echo "üì¶ –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
read -p "–í—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ—Ä–≤–µ—Ä–∞? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    ./scripts/setup-server.sh
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –í—ã–ø–æ–ª–Ω–∏—Ç–µ 'newgrp docker' –∏–ª–∏ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Docker"
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∞ –∏–ª–∏ –µ—Å–ª–∏ Docker —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω..."
fi

# –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env
echo ""
echo "‚öôÔ∏è  –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
if [ ! -f ".env" ]; then
    cp env.example .env
    echo "üìù –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª .env –∏–∑ –ø—Ä–∏–º–µ—Ä–∞"
    echo "‚ö†Ô∏è  –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º"
    echo "–ù–∞–∂–º–∏—Ç–µ Enter –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
    read
else
    echo "‚úÖ –§–∞–π–ª .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –í–∞–ª–∏–¥–∞—Ü–∏—è .env
./scripts/validate-env.sh || {
    echo "‚ùå –û—à–∏–±–∫–∏ –≤ .env —Ñ–∞–π–ª–µ. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞."
    exit 1
}

# –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL
echo ""
echo "üîê –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
if [ -f "certificate.crt" ] && [ -f "certificate.key" ]; then
    ./scripts/install-cert.sh
else
    echo "‚ö†Ô∏è  –§–∞–π–ª—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo "–ü–æ–º–µ—Å—Ç–∏—Ç–µ certificate.crt –∏ certificate.key –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞"
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter –ø–æ—Å–ª–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤..."
    ./scripts/install-cert.sh
fi

# –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx
echo ""
echo "üåê –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."
if [ ! -f "/etc/nginx/sites-available/zelyonkin.ru" ]; then
    sudo cp nginx.conf /etc/nginx/sites-available/zelyonkin.ru
    sudo ln -sf /etc/nginx/sites-available/zelyonkin.ru /etc/nginx/sites-enabled/
    sudo rm -f /etc/nginx/sites-enabled/default
    sudo nginx -t
    sudo systemctl reload nginx
    echo "‚úÖ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
else
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –®–∞–≥ 5: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
echo ""
echo "üöÄ –®–∞–≥ 5: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
./scripts/deploy.sh

# –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞
echo ""
echo "‚úÖ –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
sleep 5
./scripts/test-connection.sh

echo ""
echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: https://zelyonkin.ru"
echo "üë§ –í–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: https://zelyonkin.ru/login"
echo ""
echo "üìä –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: ./scripts/logs.sh"
echo "  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: ./scripts/monitor.sh"
echo "  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ./scripts/update.sh"
echo "  - –ë—ç–∫–∞–ø –ë–î: ./scripts/backup-db.sh"

