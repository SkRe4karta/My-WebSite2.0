generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String        @id @default(cuid())
  name           String?
  email          String        @unique
  passwordHash   String
  totpSecret     String?
  role           String        @default("admin")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  sessions       Session[]
  accounts       Account[]
  notes          Note[]
  files          FileEntry[]
  vaultItems     VaultItem[]
  journalIdeas   IdeaEntry[]
  settings       UserSetting?
  performedAudits VaultAudit[] @relation("AuditActor")
  noteTemplates  NoteTemplate[]
  tasks          Task[]
  reminders      Reminder[]
  backups        Backup[]
  apiKeys        ApiKey[]
  favorites      Favorite[]
  activityLogs   ActivityLog[]
  sharedNotes    NoteShare[]   @relation("SharedWith")
  webhooks       Webhook[]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Note {
  id          String        @id @default(cuid())
  title       String
  content     String
  format      NoteFormat    @default(MARKDOWN)
  status      NoteStatus    @default(DRAFT)
  tags        NoteTag[]
  attachments Attachment[]
  checklist   Json?
  folder      String?
  category    String?
  featured    Boolean       @default(false)
  ownerId     String
  owner       User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  versions    NoteVersion[]
  shares      NoteShare[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

enum NoteFormat {
  MARKDOWN
  PLAINTEXT
}

enum NoteStatus {
  PUBLISHED
  DRAFT
  ARCHIVED
}

model Tag {
  id    String   @id @default(cuid())
  name  String   @unique
  notes NoteTag[]
}

model NoteTag {
  noteId String
  tagId  String

  note Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([noteId, tagId])
}

model FileEntry {
  id          String       @id @default(cuid())
  name        String
  path        String       @unique
  mimeType    String?
  size        Int?
  isFolder    Boolean      @default(false)
  parentId    String?
  parent      FileEntry?   @relation("FolderChildren", fields: [parentId], references: [id])
  children    FileEntry[]  @relation("FolderChildren")
  ownerId     String
  owner       User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  attachments Attachment[] @relation("FileAttachment")
  vaultItem   VaultItem?   @relation("VaultFile")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Attachment {
  id        String   @id @default(cuid())
  noteId    String
  fileId    String
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  file      FileEntry @relation("FileAttachment", fields: [fileId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model VaultItem {
  id          String      @id @default(cuid())
  label       String
  description String?
  secretType  VaultType   @default(FILE)
  metadata    Json?
  fileId      String?     @unique
  file        FileEntry?  @relation("VaultFile", fields: [fileId], references: [id], onDelete: Cascade)
  ownerId     String
  owner       User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  auditTrail  VaultAudit[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

enum VaultType {
  FILE
  PASSWORD
  NOTE
}

model VaultAudit {
  id          String    @id @default(cuid())
  action      String
  actorId     String
  actor       User      @relation("AuditActor", fields: [actorId], references: [id], onDelete: Cascade)
  vaultItemId String
  vaultItem   VaultItem @relation(fields: [vaultItemId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
}

model IdeaEntry {
  id        String   @id @default(cuid())
  title     String
  content   String
  mood      String?
  category  String?
  tags      Json?
  date      DateTime
  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserSetting {
  id                String  @id @default(cuid())
  userId            String  @unique
  theme             String  @default("dark")
  enableAnimations  Boolean @default(true)
  dailyReminderHour Int?
  backupTarget      String?
  backupCodes       String? // JSON массив резервных кодов для 2FA
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  updatedAt         DateTime @updatedAt
}

model SecurityAudit {
  id          String   @id @default(cuid())
  userId      String?
  action      String   // Тип действия: login, login_failed, logout, password_change, 2fa_enabled, etc.
  ipAddress   String?
  userAgent   String?
  details     String?  // Дополнительные детали в JSON формате
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}

// Версионирование заметок
model NoteVersion {
  id        String   @id @default(cuid())
  noteId    String
  title     String
  content   String
  version   Int
  createdAt DateTime @default(now())
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  @@unique([noteId, version])
}

// Шаблоны заметок
model NoteTemplate {
  id          String   @id @default(cuid())
  name        String
  content     String
  description String?
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
}

// Совместный доступ к заметкам
model NoteShare {
  id          String   @id @default(cuid())
  noteId      String
  sharedWithId String
  permission  String   @default("READ") // READ, WRITE
  note        Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  sharedWith  User     @relation("SharedWith", fields: [sharedWithId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  @@unique([noteId, sharedWithId])
}

// Аналитика и активность
model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // "note_created", "file_uploaded", etc.
  entityType  String?  // "note", "file", "vault"
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId, createdAt])
  @@index([action])
}

// Задачи
model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  completed   Boolean  @default(false)
  priority    String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([ownerId, completed])
  @@index([dueDate])
}

// Напоминания
model Reminder {
  id          String   @id @default(cuid())
  taskId     String?
  noteId     String?
  message     String
  triggerAt   DateTime
  completed   Boolean  @default(false)
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  @@index([ownerId, triggerAt])
  @@index([completed])
}

// Бэкапы
model Backup {
  id          String   @id @default(cuid())
  type        String   // "manual", "scheduled", "auto"
  status      String   // "pending", "running", "completed", "failed"
  filePath    String?
  size        Int?
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  completedAt DateTime?
  @@index([ownerId, createdAt])
}

// API ключи
model ApiKey {
  id          String   @id @default(cuid())
  name        String
  key         String   @unique
  permissions Json     // массив разрешений
  lastUsedAt  DateTime?
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  @@index([key])
}

// Избранное
model Favorite {
  id          String   @id @default(cuid())
  entityType  String   // "note", "file", "vault"
  entityId    String
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  @@unique([ownerId, entityType, entityId])
}

// Проекты для портфолио
model Project {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String
  status      String   // "live", "development", "archived"
  stack       Json     // массив технологий
  githubUrl   String?
  demoUrl     String?
  imageUrl    String?
  featured    Boolean  @default(false)
  order       Int      @default(0)
  metadata    Json?    // дополнительные данные
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@index([slug])
  @@index([status])
  @@index([featured])
}

// Webhooks
model Webhook {
  id           String   @id @default(cuid())
  name         String
  url          String
  event        String   // тип события
  secret       String?
  isActive     Boolean  @default(true)
  ownerId      String
  owner        User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  lastTriggered DateTime?
  @@index([ownerId])
  @@index([event])
}
