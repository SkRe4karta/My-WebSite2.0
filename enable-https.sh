#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ HTTPS –±–ª–æ–∫–∞ –≤ nginx.conf –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

set -e

NGINX_CONF="nginx.conf"
HTTPS_TEMPLATE="nginx-https.conf.template"

echo "üîê –ê–∫—Ç–∏–≤–∞—Ü–∏—è HTTPS –±–ª–æ–∫–∞ –≤ nginx.conf..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
if [ ! -f "certbot/live/zelyonkin.ru/fullchain.pem" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!"
    echo "   –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã: ./setup-ssl.sh"
    exit 1
fi

echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞–π–¥–µ–Ω—ã"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —à–∞–±–ª–æ–Ω–∞
if [ ! -f "$HTTPS_TEMPLATE" ]; then
    echo "‚ö†Ô∏è  –®–∞–±–ª–æ–Ω $HTTPS_TEMPLATE –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±–ª–æ–∫..."
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ HTTPS –±–ª–æ–∫–∞ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å nginx.conf –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ nginx.conf..."
if docker-compose exec -T nginx nginx -t 2>/dev/null; then
    echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å nginx.conf –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
else
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (–≤–æ–∑–º–æ–∂–Ω–æ, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω)"
fi

echo ""
echo "üìù –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ HTTPS –±–ª–æ–∫–∞:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ nginx.conf"
echo "   2. –ù–∞–π–¥–∏—Ç–µ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTTPS –±–ª–æ–∫ (—Å—Ç—Ä–æ–∫–∏ ~189-341)"
echo "   3. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –±–ª–æ–∫ (—É–¥–∞–ª–∏—Ç–µ —Å–∏–º–≤–æ–ª—ã # –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫)"
echo "   4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å: docker-compose exec nginx nginx -t"
echo "   5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ nginx: docker-compose restart nginx"
echo ""
echo "üí° –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ sed –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∞—Ü–∏–∏:"
echo "   sed -i '189,341s/^[[:space:]]*#//' nginx.conf"

